# RISC-V 控制寄存器概述

RISC-V 架构定义了多个控制寄存器（CSR），这些寄存器在不同的特权模式下执行关键的系统管理和资源控制任务。根据不同的功能，RISC-V 的 CSR 可以分为多个类别，包括机器模式、监督模式、用户模式、调试模式以及超管模式。每个模式下的 CSR 管理着与内存保护、异常处理、虚拟内存、性能监控等相关的操作。以下是对 RISC-V 控制寄存器的详细介绍，帮助理解它们在不同模式下的作用及其在处理器中的关键位置。

## 一、机器模式（M-mode）CSR

这些寄存器主要由最底层的机器模式使用，负责整个系统的基础状态、异常和中断管理等关键工作：

1. **mvendorid**（地址：0xF11）  
   功能：只读寄存器，用于标识处理器的厂商。它让你知道“这是谁造的”！

2. **marchid**（地址：0xF12）  
   功能：只读寄存器，用于指明具体的架构实现（比如 RV32I、RV64I 等），帮助区分不同的 RISC-V 版本。

3. **mimpid**（地址：0xF13）  
   功能：只读寄存器，提供具体实现的 ID，方便了解底层实现细节。

4. **mhartid**（地址：0xF14）  
   功能：只读寄存器，标识当前硬件线程（hart）的 ID，在多核或多线程环境中非常有用。

5. **mstatus**（地址：0x300）  
   功能：机器状态寄存器，保存全局状态信息，如全局中断使能、当前和以前的特权级别等。它就像处理器的“心跳记录”，时刻反映着系统的运行状态。

6. **misa**（地址：0x301）  
   功能：机器 ISA 寄存器，编码了当前处理器支持的指令集扩展（比如浮点、向量等）以及处理器位宽信息。它让你一眼就能看出“我能做什么”。

7. **medeleg**（地址：0x302）  
   功能：异常委托寄存器，用来决定哪些异常可以由低特权级（如 S-mode）处理，从而简化机器模式下的异常处理流程。

8. **mideleg**（地址：0x303）  
   功能：中断委托寄存器，类似于 medeleg，但专门用于中断。它允许将部分中断任务下放给监督模式处理。

9. **mie**（地址：0x304）  
   功能：机器中断使能寄存器，每一位对应一个中断源，控制哪些中断在机器模式下被允许响应。

10. **mtvec**（地址：0x305）  
    功能：机器陷阱向量寄存器，存储异常或中断发生时跳转到的处理程序入口地址。它支持直接模式和向量模式配置，决定了陷阱处理的跳转方式。

11. **mcounteren**（地址：0x306）  
    功能：机器计数器使能寄存器，控制哪些机器级性能计数器可以在较低特权级（如 S-mode 或 U-mode）下访问。

12. **mscratch**（地址：0x340）  
    功能：备用寄存器，供机器模式下的陷阱处理程序使用，用于临时保存数据或上下文信息。

13. **mepc**（地址：0x341）  
    功能：机器异常程序计数器，在发生异常时记录导致异常的指令地址，异常处理结束后可从这里恢复执行。

14. **mcause**（地址：0x342）  
    功能：机器陷阱原因寄存器，记录触发陷阱（异常或中断）的具体原因。

15. **mtval**（地址：0x343）  
    功能：机器陷阱值寄存器，提供与异常相关的附加信息，比如错误的地址或错误指令等。

16. **mip**（地址：0x344）  
    功能：机器中断待处理寄存器，指示各个中断源当前是否处于待处理状态，与 mie 搭配使用，保证中断处理的及时性。

17. **性能计数器（Performance Counters）**  
    这些寄存器用于性能监控（如果实现了相关扩展）：  
    - **mcycle**（0xB00）与 **mcycleh**（0xB80）：记录自启动以来的时钟周期数（低位与高位）。  
    - **minstret**（0xB02）与 **minstreth**（0xB82）：记录已执行指令的数量（低位与高位）。  
    - 另外还有一系列的 **mhpmcounter3** 至 **mhpmcounter31** 及其高位版本，用于更细粒度的性能监控。

18. **物理内存保护（PMP）寄存器**  
    用于实现对物理内存访问的保护：  
    - **pmpcfgX**：配置 PMP 区域的属性（如读、写、执行权限）。  
    - **pmpaddrX**：指定 PMP 区域的地址范围。

---

## 二、监督模式（S-mode）CSR

在操作系统或监控程序中，监督模式下的 CSR 用于管理虚拟内存、异常处理及中断等：

1. **sstatus**  
   功能：监督状态寄存器，其内容一般是 mstatus 的一个子集，反映了当前 S-mode 下的状态（比如中断使能、特权级等）。

2. **sie**（地址：0x104）  
   功能：监督中断使能寄存器，控制 S-mode 下哪些中断被允许响应。

3. **stvec**（地址：0x105）  
   功能：监督陷阱向量寄存器，存储 S-mode 下陷阱处理程序的入口地址，同样支持直接和向量模式。

4. **scounteren**（地址：0x106）  
   功能：监督计数器使能寄存器，决定哪些机器级性能计数器可在 S-mode 下被访问。

5. **sscratch**（地址：0x140）  
   功能：监督备用寄存器，为 S-mode 下的陷阱处理提供临时存储空间。

6. **sepc**（地址：0x141）  
   功能：监督异常程序计数器，记录 S-mode 下发生异常时的返回地址。

7. **scause**（地址：0x142）  
   功能：监督陷阱原因寄存器，指明导致 S-mode 异常或中断的原因。

8. **stval**（地址：0x143）  
   功能：监督陷阱值寄存器，提供与异常相关的额外信息，如错误地址等。

9. **sip**（地址：0x144）  
   功能：监督中断待处理寄存器，反映 S-mode 下各中断源的待处理状态。

10. **satp**（地址：0x180）  
    功能：监督地址转换和保护寄存器，是虚拟内存实现的关键。它配置页表的基地址、地址转换模式（如 Sv39、Sv48 等）以及 ASID（地址空间标识符）。

---

## 三、用户模式（U-mode）CSR

用户模式下直接能访问的 CSR 相对较少，主要集中在浮点操作和性能计数器方面：

1. **浮点相关寄存器**  
    - **fflags**（地址：0x001）  
      功能：浮点异常标志寄存器，记录浮点运算过程中产生的异常。  
    - **frm**（地址：0x002）  
      功能：浮点舍入模式寄存器，指定当前的浮点运算舍入方式。  
    - **fcsr**（地址：0x003）  
      功能：综合了 fflags 和 frm 的浮点控制状态寄存器，用于管理和报告浮点运算状态。

2. **用户级性能计数器**  
    - **cycle**（地址：0xC00）、**time**（地址：0xC01）、**instret**（地址：0xC02）  
      功能：这些寄存器分别提供时钟周期数、时间和已执行指令数，供用户级程序进行性能统计和优化分析。

---

## 四、调试模式（Debug Mode）CSR（如果实现了调试扩展）

为了支持调试操作，RISC-V 定义了一组专门的调试寄存器：

1. **dcsr**（地址：0x7B0）  
   功能：调试控制和状态寄存器，用于配置调试模式下的行为并报告当前调试状态。

2. **dpc**（地址：0x7B1）  
   功能：调试程序计数器，保存进入调试模式前的 PC 值，便于调试结束后恢复程序执行。

3. **dscratch0**（地址：0x7B2） 与 **dscratch1**（地址：0x7B3）  
   功能：调试备用寄存器，为调试器提供临时存储空间。

---

## 五、超管模式（Hypervisor Mode）CSR（如果支持超管扩展）

在支持虚拟化的系统中，会增加一组超管模式的 CSR，用于管理虚拟机和资源隔离：

1. **hstatus**（地址：0x600）  
   功能：超管状态寄存器，管理虚拟化环境下的状态信息。

2. **hedeleg**（地址：0x602） 与 **hideleg**（地址：0x603）  
   功能：分别用于异常和中断的委托，允许将部分处理任务下放给低特权级的虚拟机。

3. **hcounteren**（地址：0x606）  
   功能：超管计数器使能寄存器，控制性能计数器在超管模式下的访问权限。

4. **其他**：还可能包括如 htval、htimedelta 等，用于辅助虚拟化管理。

---

## 小贴士

- **扩展性**：需要注意的是，以上 CSR 列表主要涵盖了 RISC-V 特权架构规范中定义的标准寄存器。具体实现可能会因厂商、扩展（如 PMP、调试、超管）而有所不同，某些寄存器可能是可选实现的。
- **层次分明**：从机器模式到用户模式，每个层级都有自己专属的寄存器，既保证了安全性，也使得异常处理、虚拟内存管理等工作井然有序。
