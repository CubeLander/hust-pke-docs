# 硬件对软中断的响应过程

在通过 `stvec` 跳转到 `smode_trap_vector` 之前，RISC-V CPU 会自动执行一系列硬件操作，这些操作是由硬件为了保存当前执行状态和准备跳转到异常处理程序（即 `smode_trap_vector`）所必须的。以下是这些自动发生的硬件过程：

1. **保存 `epc`（程序计数器）**  
   当发生中断或异常时，RISC-V 硬件会自动将当前程序计数器（PC）值存储到 `sepc` 寄存器中。`sepc` 保存了触发异常时的指令地址，通常是异常发生前一条指令的地址。

2. **保存 `sstatus`（状态寄存器）**  
   硬件会自动保存 `sstatus` 寄存器的当前值。`sstatus` 寄存器包含了处理器的特权级、当前的中断使能状态以及其他控制位。  
   - **SSTATUS_SPP**：保存程序的先前特权级，指示进入异常时是来自于用户模式还是内核模式。  
   - **SSTATUS_SPIE**：指示中断使能状态，特别是中断是否在异常发生时被禁用。

3. **保存 `scause`（异常原因寄存器）**  
   硬件会自动将异常的原因（例如，是来自用户程序的 `ecall`，还是其他异常）存储到 `scause` 寄存器中。`scause` 会指示导致跳转到异常处理程序的具体原因（例如 `CAUSE_USER_ECALL`，表示来自用户程序的系统调用）。

4. **保存 `stval`（异常地址寄存器）**  
   如果异常类型与地址相关（例如，页面错误、地址访问错误等），硬件会自动将错误的地址存储在 `stval` 寄存器中。对于大多数系统调用和普通异常，`stval` 的内容可能不被使用，但它会在发生地址错误或非法访问时提供额外信息。

5. **禁用中断**  
   当发生异常时，硬件会自动禁用中断，防止中断嵌套。这通常通过修改 `SSTATUS_SPIE` 来实现，确保在异常处理期间中断不会干扰。

6. **跳转到 `stvec`（异常向量寄存器）**  
   `stvec` 寄存器用于指定异常处理的入口地址。RISC-V 硬件会使用 `stvec` 中存储的地址来跳转到异常处理程序。在这个实验中，`stvec` 在用户程序初始化时被设置为 `smode_trap_vector`，因此硬件在发生异常后，会跳转到 `smode_trap_vector` 的地址。

---

## 总结：硬件自动发生的操作

1. **保存当前程序计数器**：硬件会自动将当前的 PC 值存储到 `sepc`。
2. **保存状态信息**：硬件自动保存 `sstatus`、`scause` 和 `stval`，提供异常原因和相关上下文。
3. **禁用中断**：硬件禁用中断，防止异常期间的中断干扰。
4. **跳转到 `stvec` 指定的异常处理地址**：硬件根据 `stvec` 寄存器的设置，将控制权转交给指定的异常处理程序地址。

这些操作确保了系统能够安全地处理异常和中断，并在处理完异常后正确地恢复程序的执行。
