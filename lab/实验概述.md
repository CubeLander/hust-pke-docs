# 实验概述
## 一、总览

本次实验的主要目标是构建并验证一个基于 RISC-V 架构的代理内核程序。这个内核通过对底层硬件资源进行虚拟化管理，为上层用户程序提供一个安全、隔离且易于扩展的执行环境。实验体系结构采用三级嵌套模式，整体架构如下：

**Spike 仿真器 → RISC-V 代理内核 → 用户程序**

## 二、参考资料
- [Spike中HTIF的原理](../doc/Spike中HTIF的原理.md)



## 三、Spike 仿真器

### 角色与功能
Spike 仿真器作为最底层运行环境，模拟真实 RISC-V 处理器的硬件行为和指令执行。它提供了一套完整的指令集模型，使得在不依赖实际硬件的平台上也能进行 RISC-V 内核和应用程序的调试、验证和功能测试。

### 作用
在本实验中，Spike 仿真器负责接收来自上层代理内核的指令，并与实际内核通信，模拟执行相关硬件操作和系统调用，成为实验平台的“物理层”，确保上层软件运行时能够与底层硬件模型进行正确交互。

## 四、 RISC-V 代理内核

### 核心设计
代理内核位于 Spike 仿真器与用户程序之间，其设计理念是通过虚拟化技术对硬件资源进行抽象和管理。代理内核负责拦截和处理用户程序的系统调用请求、管理虚拟内存、调度执行以及分配其他系统资源。

### 主要职责
- **内存虚拟化与管理**：代理内核为用户程序创建并维护独立的虚拟地址空间。通过页表等数据结构实现虚拟地址与物理地址之间的映射，保证用户程序获得的内存区域互相独立，且不直接暴露底层物理资源。
- **资源分配与隔离**：除内存之外，代理内核还负责管理其他关键资源（如 CPU 时间、I/O 资源等），并对用户程序进行隔离，防止程序之间的相互干扰。
- **系统调用与异常处理**：内核为用户程序提供统一的系统调用接口，用户程序在执行过程中遇到异常或资源请求时，均由代理内核统一处理并调度相应的操作。

### 优势与应用
通过代理内核的虚拟化管理，不仅可以提高系统的安全性和稳定性，而且为实验教学提供了一个简化但真实的内核设计平台，使学生能够直观地理解操作系统核心机制（如内存管理、进程调度、系统调用接口等）的实现原理。

## 五、用户程序

### 运行环境
用户程序作为实验中的应用层，运行在代理内核提供的虚拟化环境之上。其所有的内存、I/O 等资源均由代理内核进行动态分配和管理，用户程序通过标准接口（类似传统操作系统中的系统调用）与内核进行交互。

### 开发与调试
用户程序可以是特定功能的实验验证代码，也可以作为内核虚拟化管理效果的展示。程序开发者无需关心底层硬件细节，而专注于业务逻辑的实现，同时也可以借助 Spike 仿真器和调试工具，对整个系统的行为进行监控和调试。


## 六、系统工作流程

### 1. 启动阶段
- Spike 仿真器启动，并加载 RISC-V 代理内核映像。
- 代理内核初始化自身数据结构，包括虚拟内存管理、系统调用表、资源管理模块等。

### 2. 用户程序加载与虚拟化分配
- 在内核初始化完成后，代理内核根据用户程序的需求（例如加载 ELF 格式的可执行文件），为用户程序分配独立的虚拟地址空间。
- 通过建立页表和分段机制，代理内核将用户程序的代码、数据及堆栈区域映射到预设的（其实就是代理内核在主机上的）物理内存区域，同时确保不同用户程序之间的资源隔离。

### 3. 执行与交互
- 用户程序运行过程中，当遇到内存访问、I/O 操作或其他需要操作系统支持的请求时，会通过系统调用进入代理内核。
- 代理内核根据调用类型进行处理，例如分配更多内存、进行设备模拟或执行特定的调度策略，处理完成后再将控制权返回给用户程序。
- Spike 仿真器则负责模拟实际硬件对这些操作的响应，保证整个虚拟化过程与真实硬件平台的一致性。

### 4. 异常与退出处理
- 当用户程序运行过程中出现异常或终止请求时，代理内核负责捕获系统调用和处理相关异常信息，确保系统资源得到及时回收并记录相关日志。
- 最终，代理内核在完成所有必要清理工作后，将控制权返还给 Spike 仿真器，完成整个程序的生命周期。



## 总结

本次 RISC-V 代理内核实验通过构建一套从 Spike 仿真器到代理内核，再到用户程序的三级嵌套系统，成功实现了内存和其他资源的虚拟化分配。实验不仅让学生直观地了解了操作系统核心技术（如内存管理、系统调用、资源隔离）的实现原理，也为进一步研究 RISC-V 平台上的轻量级虚拟化技术提供了坚实的实践基础。通过这种架构设计，用户程序可以在一个安全、独立的虚拟环境中运行，而代理内核则成为连接硬件抽象层与用户应用层的关键桥梁。
